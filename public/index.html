<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentBeacon Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5a67d8',
                        accent: '#38b2ac',
                        dark: '#22223b',
                        light: '#f7fafc'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light min-h-screen">
    <!-- Add Modal HTML -->
    <div id="agentModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
                <h2 class="text-xl font-semibold text-gray-900" id="modalTitle">Agent Details</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6" id="modalContent"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center gap-3">
                        <svg class="w-8 h-8" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="22" stroke="#5a67d8" stroke-width="4" fill="url(#beacon-gradient)"/>
                            <circle cx="24" cy="24" r="8" fill="#5a67d8" fill-opacity="0.9"/>
                            <defs>
                                <linearGradient id="beacon-gradient" x1="0" y1="0" x2="48" y2="48">
                                    <stop stop-color="#5a67d8"/>
                                    <stop offset="1" stop-color="#38b2ac"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <span class="text-xl font-bold text-dark">AgentBeacon</span>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-gray-600 hover:text-primary">Home</a>
                    <a href="https://github.com/chadstachowicz/AgentBeacon" target="_blank" class="text-gray-600 hover:text-primary flex items-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.58 2 12.26c0 4.5 2.87 8.32 6.84 9.67.5.09.68-.22.68-.48 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.36-3.37-1.36-.45-1.18-1.1-1.5-1.1-1.5-.9-.63.07-.62.07-.62 1 .07 1.53 1.05 1.53 1.05.89 1.56 2.34 1.11 2.91.85.09-.66.35-1.11.63-1.37-2.22-.26-4.56-1.14-4.56-5.07 0-1.12.39-2.03 1.03-2.75-.1-.26-.45-1.3.1-2.7 0 0 .84-.28 2.75 1.05A9.38 9.38 0 0 1 12 6.84c.85.004 1.71.12 2.51.35 1.91-1.33 2.75-1.05 2.75-1.05.55 1.4.2 2.44.1 2.7.64.72 1.03 1.63 1.03 2.75 0 3.94-2.34 4.81-4.57 5.07.36.32.68.94.68 1.9 0 1.37-.01 2.47-.01 2.81 0 .27.18.58.69.48A10.01 10.01 0 0 0 22 12.26C22 6.58 17.52 2 12 2Z"/>
                        </svg>
                        GitHub
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Stats Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-sm font-medium text-gray-500">Registered Agents</h3>
                <p class="mt-2 text-3xl font-bold text-primary" id="agentCount">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-sm font-medium text-gray-500">Connected Peers</h3>
                <p class="mt-2 text-3xl font-bold text-primary" id="peerCount">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-sm font-medium text-gray-500">Uptime</h3>
                <p class="mt-2 text-3xl font-bold text-primary" id="uptime">0s</p>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-sm font-medium text-gray-500">Network Status</h3>
                <p class="mt-2 flex items-center" id="connectionStatus">
                    <span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span>
                    <span class="text-lg font-semibold text-gray-700">Disconnected</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-medium text-dark">ðŸ¤– Registered Agents</h2>
            </div>
            <div class="p-6" id="agentsList">
                <div class="text-center py-12">
                    <h3 class="text-lg font-medium text-gray-900">No agents registered yet</h3>
                    <p class="mt-2 text-sm text-gray-500">Agents will appear here when they register with the beacon network</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Log -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-8">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-medium text-dark">ðŸ“¡ Live Events</h2>
                <div class="space-x-2">
                    <button id="refreshBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                        Refresh
                    </button>
                    <button id="clearLogBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-opacity-90 transition-colors">
                        Clear Log
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="eventLog" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="p-3 bg-green-50 text-green-700 rounded-md">
                        Dashboard loaded and ready to receive events
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BeaconDashboard {
            constructor() {
                this.beaconUrl = window.location.origin;
                this.ws = null;
                this.agents = new Map();
                this.isConnected = false;
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadInitialData();
                this.connectWebSocket();
                this.startHeartbeat();
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadInitialData();
                });

                document.getElementById('clearLogBtn').addEventListener('click', () => {
                    this.clearEventLog();
                });
            }

            async loadInitialData() {
                try {
                    const healthResponse = await fetch(`${this.beaconUrl}/health`);
                    const healthData = await healthResponse.json();
                    this.updateStats(healthData);

                    const agentsResponse = await fetch(`${this.beaconUrl}/agents`);
                    const agentsData = await agentsResponse.json();
                    this.updateAgentsList(agentsData.agents);

                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.addEvent('Failed to connect to beacon node', 'error');
                }
            }

            connectWebSocket() {
                const wsUrl = this.beaconUrl.replace('http', 'ws');
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.addEvent('Connected to beacon node', 'connected');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };

                this.ws.onclose = () => {
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.addEvent('Disconnected from beacon node', 'disconnected');
                    
                    setTimeout(() => {
                        if (!this.isConnected) {
                            this.connectWebSocket();
                        }
                    }, 5000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.addEvent('WebSocket connection error', 'error');
                };
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'agent_registered':
                        this.addAgent(data.agent);
                        this.addEvent(`Agent registered: ${data.agent.name}`, 'registered');
                        break;
                        
                    case 'agent_discovered':
                        this.addAgent(data.agent);
                        this.addEvent(`Agent discovered: ${data.agent.name}`, 'discovered');
                        break;
                        
                    case 'agent_unregistered':
                        this.removeAgent(data.agent.id);
                        this.addEvent(`Agent unregistered: ${data.agent.name}`, 'unregistered');
                        break;
                        
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }

            addAgent(agent) {
                this.agents.set(agent.id, agent);
                this.updateAgentsList(Array.from(this.agents.values()));
                this.updateAgentCount();
            }

            removeAgent(agentId) {
                this.agents.delete(agentId);
                this.updateAgentsList(Array.from(this.agents.values()));
                this.updateAgentCount();
            }

            updateAgentsList(agents) {
                const agentsList = document.getElementById('agentsList');
                
                if (agents.length === 0) {
                    agentsList.innerHTML = `
                        <div class="text-center py-12">
                            <h3 class="text-lg font-medium text-gray-900">No agents registered yet</h3>
                            <p class="mt-2 text-sm text-gray-500">Agents will appear here when they register with the beacon network</p>
                        </div>
                    `;
                    return;
                }

                agentsList.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${agents.map(agent => `
                            <div class="bg-gray-50 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer" 
                                 onclick="showAgentDetails(${JSON.stringify(agent).replace(/"/g, '&quot;')})">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">${agent.name}</h3>
                                        <div class="text-sm font-mono text-gray-500 mt-1">ID: ${agent.id}</div>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${agent.status === 'online' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                        ${agent.status || 'unknown'}
                                    </span>
                                </div>
                                <p class="mt-2 text-sm text-gray-600">${agent.description || ''}</p>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    ${(() => {
                                        let capabilities = agent.capabilities;
                                        if (Array.isArray(capabilities)) {
                                            return capabilities.map(cap => 
                                                `<span class="px-2 py-1 bg-primary bg-opacity-10 text-primary text-xs rounded-full">${cap}</span>`
                                            ).join('');
                                        } else if (typeof capabilities === 'object' && capabilities !== null) {
                                            return Object.entries(capabilities)
                                                .filter(([key, value]) => value)
                                                .map(([key]) => 
                                                    `<span class="px-2 py-1 bg-primary bg-opacity-10 text-primary text-xs rounded-full">${key}</span>`
                                                ).join('');
                                        }
                                        return '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">No capabilities</span>';
                                    })()}
                                </div>
                                ${agent.tags ? `
                                    <div class="mt-2 flex flex-wrap gap-2">
                                        ${agent.tags.map(tag => 
                                            `<span class="px-2 py-1 bg-accent bg-opacity-10 text-accent text-xs rounded-full">${tag}</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                                <div class="mt-4 text-xs text-gray-500">
                                    Registered: ${new Date(agent.registeredAt).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            updateStats(healthData) {
                document.getElementById('agentCount').textContent = healthData.agentCount || 0;
                document.getElementById('peerCount').textContent = healthData.peerCount || 0;
                document.getElementById('uptime').textContent = this.formatUptime(healthData.uptime || 0);
            }

            updateAgentCount() {
                document.getElementById('agentCount').textContent = this.agents.size;
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                if (connected) {
                    statusElement.innerHTML = `
                        <span class="h-3 w-3 rounded-full bg-green-500 mr-2"></span>
                        <span class="text-lg font-semibold text-gray-700">Connected</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span>
                        <span class="text-lg font-semibold text-gray-700">Disconnected</span>
                    `;
                }
            }

            addEvent(message, type = 'info') {
                const eventLog = document.getElementById('eventLog');
                const eventItem = document.createElement('div');
                
                const typeClasses = {
                    registered: 'bg-green-50 text-green-700',
                    discovered: 'bg-blue-50 text-blue-700',
                    unregistered: 'bg-red-50 text-red-700',
                    error: 'bg-red-50 text-red-700',
                    connected: 'bg-green-50 text-green-700',
                    disconnected: 'bg-gray-50 text-gray-700',
                    info: 'bg-gray-50 text-gray-700'
                };
                
                eventItem.className = `p-3 rounded-md ${typeClasses[type] || typeClasses.info}`;
                eventItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                eventLog.appendChild(eventItem);
                eventLog.scrollTop = eventLog.scrollHeight;
                
                while (eventLog.children.length > 50) {
                    eventLog.removeChild(eventLog.firstChild);
                }
            }

            clearEventLog() {
                document.getElementById('eventLog').innerHTML = '';
            }

            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${secs}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }

            startHeartbeat() {
                setInterval(async () => {
                    if (this.isConnected) {
                        try {
                            const response = await fetch(`${this.beaconUrl}/health`);
                            const data = await response.json();
                            this.updateStats(data);
                        } catch (error) {
                            console.warn('Heartbeat failed:', error);
                        }
                    }
                }, 10000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new BeaconDashboard();
        });
    </script>

    <!-- Add Modal JavaScript -->
    <script>
        function showAgentDetails(agent) {
            const modal = document.getElementById('agentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = agent.name;

            // Helper function to format object/array data
            function formatValue(value) {
                if (Array.isArray(value)) {
                    return value.length ? value.map(v => 
                        `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">${v}</span>`
                    ).join(' ') : '<span class="text-gray-500 italic">None</span>';
                } else if (typeof value === 'object' && value !== null) {
                    return Object.entries(value).map(([k, v]) => 
                        `<div class="ml-4 mt-1">
                            <span class="font-medium">${k}:</span> ${formatValue(v)}
                        </div>`
                    ).join('');
                } else if (typeof value === 'boolean') {
                    return value ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-700 text-sm rounded-full">Yes</span>' : 
                        '<span class="px-2 py-1 bg-red-100 text-red-700 text-sm rounded-full">No</span>';
                } else if (value === null || value === undefined || value === '') {
                    return '<span class="text-gray-500 italic">None</span>';
                }
                return value;
            }

            // Helper function to format capabilities (object or array)
            function formatCapabilities(capabilities) {
                if (Array.isArray(capabilities)) {
                    return capabilities.length ? capabilities.map(cap => 
                        `<span class="px-2 py-1 bg-primary bg-opacity-10 text-primary text-sm rounded-full">${cap}</span>`
                    ).join(' ') : '<span class="text-gray-500 italic">None</span>';
                } else if (typeof capabilities === 'object' && capabilities !== null) {
                    return Object.entries(capabilities).map(([key, value]) => 
                        `<div class="flex items-center justify-between py-1">
                            <span class="text-sm font-medium">${key}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${value ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${value ? 'Yes' : 'No'}
                            </span>
                        </div>`
                    ).join('');
                }
                return '<span class="text-gray-500 italic">None</span>';
            }

            // Helper function to format skills array
            function formatSkills(skills) {
                if (!Array.isArray(skills) || skills.length === 0) {
                    return '<span class="text-gray-500 italic">None</span>';
                }
                return skills.map(skill => 
                    `<div class="border border-gray-200 rounded-lg p-3 mt-2">
                        <div class="font-medium text-sm">${skill.name || skill.id}</div>
                        ${skill.description ? `<div class="text-xs text-gray-600 mt-1">${skill.description}</div>` : ''}
                        ${skill.tags ? `<div class="mt-2 flex flex-wrap gap-1">
                            ${skill.tags.map(tag => `<span class="px-1.5 py-0.5 bg-accent bg-opacity-10 text-accent text-xs rounded">${tag}</span>`).join('')}
                        </div>` : ''}
                        ${skill.examples ? `<div class="mt-2">
                            <div class="text-xs font-medium text-gray-500">Examples:</div>
                            ${skill.examples.map(example => `<div class="text-xs text-gray-600 italic">â€¢ ${example}</div>`).join('')}
                        </div>` : ''}
                    </div>`
                ).join('');
            }

            // Create details content
            const agentUrl = agent.url || agent.endpoint;
            const details = [
                { label: 'ID', value: agent.id, type: 'code' },
                { label: 'URL', value: agentUrl, type: 'url', show: true },
                { label: 'Description', value: agent.description },
                { label: 'Version', value: agent.version },
                { label: 'Status', value: agent.status, type: 'status' },
                { label: 'Capabilities', value: agent.capabilities, type: 'capabilities' },
                { label: 'Authentication', value: agent.authentication, type: 'object' },
                { label: 'Default Input Modes', value: agent.defaultInputModes, type: 'tags' },
                { label: 'Default Output Modes', value: agent.defaultOutputModes, type: 'tags' },
                { label: 'Skills', value: agent.skills, type: 'skills' },
                { label: 'Tags', value: agent.tags, type: 'tags' },
                { label: 'Metadata', value: agent.metadata, type: 'object' },
                { label: 'Registered At', value: new Date(agent.registeredAt).toLocaleString() },
                { label: 'Registered By', value: agent.registeredBy },
                { label: 'Last Seen', value: new Date(agent.lastSeen).toLocaleString() }
            ];

            modalContent.innerHTML = `
                <div class="space-y-4">
                    ${details.filter(d => d.show || (d.value !== null && d.value !== undefined && d.value !== '')).map(({ label, value, type }) => `
                        <div class="border-b border-gray-100 pb-4 last:border-0">
                            <div class="text-sm font-medium text-gray-500 mb-1">${label}</div>
                            <div class="text-gray-900">
                                ${type === 'code' ? 
                                    `<code class="px-2 py-1 bg-gray-100 rounded font-mono text-sm">${value || 'N/A'}</code>` :
                                  type === 'url' ? 
                                    (value ? 
                                        `<div class="flex items-center gap-2">
                                            <a href="${value}" target="_blank" class="text-primary hover:underline font-medium">${value}</a>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                        </div>` : 
                                        '<span class="text-gray-500 italic">No URL provided</span>') :
                                  type === 'status' ? 
                                    `<span class="px-2 py-1 text-sm rounded-full ${value === 'online' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">${value || 'unknown'}</span>` :
                                  type === 'capabilities' ? 
                                    formatCapabilities(value) :
                                  type === 'skills' ?
                                    formatSkills(value) :
                                    formatValue(value)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Show modal
            modal.classList.remove('hidden');

            // Close modal handlers
            const closeModal = () => {
                modal.classList.add('hidden');
            };

            document.getElementById('closeModal').onclick = closeModal;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
        }
    </script>
</body>
</html> 